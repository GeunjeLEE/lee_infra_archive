# 병목 규명 작업의 기본적인 흐름
부하분산이란 말 그대로 여러 호스트로 처리를 분담 시키는 것을 의미한다.<br>
하지만 1대의 서버로도 처리할 수 있는 부하를 여러대의 서버로 분산하는 것은 본 말이 전도된 것이다.<br>
먼저 단일 서버의 성능을 충분히 끌어낸 다음에 여러 서버로 분산 시켜야 한다는 것이다.

병목을 규정하기 위한 작업을 크게 나누면 다음과 같다.
- Load Average 확인
- CPU I/O 중 병목 원인 조사

## 1. Load Average 확인
top,uptime등의 명령으로 Load Average를 확인한다.<br>
Load Average는 시스템 전체의 부하상황을 나타내는 지표지만, 이것으로는 병목의 원인이 어딘지 판단할 수 없다.<br>
Load Average를 시초로 해서 병목 지점에 대한 조사를 시작한다.

예를 들어 Load Average는 낮은데, 시스템의 전송량이 오르지 않을 경우도 가끔 있다.<br>
이럴때는 SW의 설정이나 오류, 네트워크, 원격 호스트측에 원인이 없는지 등을 살펴본다.

## 2. CPU, I/O 중 병목 원인 조사
Load Average가 높은 경우, 다음으로 CPU와 I/O 어느 쪽에 원인이 있는지를 조사한다.<br>
sar, vmstat로 시간 경과에 따라 cpu사용률이나, I/O 대기율의 추이를 확인하고 이를 참고해서 규명한다.

확인 후 다음 단계로 넘어간다.

### 2-1. CPU 부하가 높은 경우
아래와 같은 흐름으로 조사해간다.

- 사용자 프로그램 처리가 병목인지, 시스템 프로그램이 원인인지 확인한다.
  - top, sar로 확인한다.
- ps로 볼 수 있는 프로세스의 상태나, CPU 사용시간 등을 보면서 원인이 되고 있는 프로세스를 찾는다.
- 프로세스를 찾은 후 보다 상세하게 조사할 경우는 strace로 추적하거나, oprofile로 프로파일링을 해서 병목 지점을 좁혀간다.

일반적으로 CPU에 부하가 걸리고 있는 것은 다음 상황 중 하나다.
- 디스크나 메모리 용량 등 그 밖의 부분에서는 병목이 되지 않는 경우
  - 이러한 상황에서 시스템의 전송량에 문제가 있다면 서버 증설이나 프로그램의 로직, 알고리즘을 개선해서 대응한다.
- 프로그램이 폭주해서 CPU에 필요 이상의 부하가 걸리는 경우
  - 오류를 제거해서 프로그램이 폭주하지 않도록 대처한다.

### 2-2. I/O 부하가 높은 경우
I/O 부하가 높은 경우, 프로그램으로부터 입출력이 많아서 부하가 높거나<br>
스왑이 발생해서 디스크 액세스가 발생하고 있는 상황 중 하나일 경우가 대부분이다.(sar,vmstat로 스왑의 발생상황을 확인한다.)

- 스왑이 발생하고 있는 경우
  - 특정 프로세스가 극단적으로 메모리를 소비하고 있지 않은지를 ps로 확인한다.
    - ps auxww --sort -resident | head -n 10
  - 프로그램의 오류로 메모리를 지나치게 사용하고 있는 경우에 프로그램을 개선한다.
  - 탑재된 메모리가 부족한 경우 증설을 검토하거나, 어려운 경우 분산을 검토한다.

스왑이 발생하지 않고 디스크로의 입출력이 빈번하게 발생하고 있는 상황은 캐시에 필요한 메모리가 부족한 경우를 생각해볼 수 있다.

- 해당 서버가 저장하고 있는 데이터 용량과 증설 가능한 메모리량을 비교해서
  - 메모리 증설로 캐시 영역을 확대시킬 수 있는 경우는 메모리를 증설한다.
  - 메모리 증설로 대응할 수 없는 경우, 데이터 분산이나 캐시서버 도입 등을 검토한다.
    - 물론 프로그램을 개선해서 I/O 빈도를 줄이는 것도 검토한다.

  

