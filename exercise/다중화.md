# DNS
## DNS 다중화
- DNS 다중화는 좀처럼 발생하지 않지만, 일단 발생하면 원인이 판명되기까지 시간이 걸린다.

## 주소변환 라이브러리를 이용한 다중화
- 주소변환 라이브러리는 /etc/resolv.conf를 참조해서 질의할 DNS서버를 얻는다.
  - 즉, 가장 단순하게 생각해볼 수 있는 DNS 다중화는 /etc/resolv.conf에 여러 DNS서버를 지정하는 것이다.
  - /etc/resolv.conf에 여러대의 서버가 지정된 경우, 나열된 순으로 질의를 수행한다.
  - nameserver 엔트리가 없는 경우, default로는 로컬 머신상의 네임서버가 사용된다.
  - 알고리즘은
    - 먼저 네임서버에 질의를 한다.
    - 이 질의가 타임아웃 된 경우, 다음 네임서버에 질의를 한다.
    - 이 동작을 네임서버가 없을 때까지 반복한다.
    - 그럼에도 응답이 없는 경우는 최대 재시도 횟수에 이를 때까지 모든 네임서버에 질의를 반복한다.
  - 문제점
    - [질의가 타임아웃 된 경우, 다음 네임서버에 질의를 한다.]라는 동작에 다소 문제가 있는데
      - 최조 지정된 DNS서버가 다운되면 타임아웃(default 5초)를 대기한 후 다음 서버로 질의한다.
      - 다소 극단적이지만, 여러 요청이 이러한 타임아웃 시간을 대기한다면 
      - 크게 봤을때 상당한 성능차이를 가져올 수 있다.
      - 성능은 저하되지만 에러는 발생하지 않는 상황이 지속되면, 장애의 발견을 늦추는 요인이 된다.
      - ex) 메일서버
        - 1시간에 1000통의 메일을 전송하는 메일서버가
        - 지속적인 DNS 질의 타임아웃으로 인해 1회당 5초의 타임아웃을 겪게 된다면
        - 그만큼 보낼 수 있는 메일의 수가 줄어든다.

## VRRP를 이용한 구성
- VRRP를 이용해 DNS서버 자체를 다중화한다.
  - keepalived가 있겠다.
  - 두 서버가 실행중인 상태해서 Active인 서버가 다운되면 VIP가 standby로 할당되면서 failover를 한다.
  - 서버 다운이나, Keepalived의 정지로 인해 failover가 이루어지지만, 
  - DNS 서비스 정지에 의한 failover는 이루어지지 않기 때문에
  - 자기 자신에게 DNS질의를 해서 dig명령이 비정상 종료하면 keepalived를 정지시킨다.
    - script를 작성해서 지속적으로 헬스체크를 한다.
  - 이에 따라 DNS 서비스가 정지되어도 failover가 일어날 수 있도록 한다.
- APP이나 웹 서버의 /etc/resolv.conf에 VIP만을 설정한 후
  - 해당 VIP를 VRRP로 다중화해둔 DNS 서버중 하나의 서버에 VIP를 할당한다.

## DNS 부하분산
- Active<->Standby와 같은 구성으로 다중화 구성을 할 수 있지만
- 앞단에 LB를 배치하고, VIP를 할당하는 것으로 Active<->Active 구성을 생각해볼 수 있다.

# 스토리지
- 서버에 장착된 하드 디스크 고장에 의해 데이터가 손실되면 당연하지만 곤란한 상황이 된다.
  - RAID 구성을 이용해 하드디스크 고장에 의해 데이터가 손실되지 않도록 구성하는 것이 일반적이다.
- 다만, 고장이 나는건 하드 디스크만이 아니다.
  - RAID 컨트롤러가 고장난 경우, 운이 나쁘면 데이터 손실이 발생할 수 있다.(예기치 않은 데이터를 덮어써서?)
- 때문에 스토리지 서버를 다중화 해두는 것도 좋은 대처방안이 될 수 있다.
  - 또한 다중화 하려면 두대의 서버에 데이터를 계속해서 동기화할 필요가 있다(정합성)
- DRBD 소프트웨어를 사용하여 HA 클러스터 구성을 생각해본다.

## DRBD를 이용한 스토리지 서버 다중화
- DRBD
  - HA 클러스터를 구성할 때 유용한 블록 디바이스를 제공한다.
  - 가능하면 전용 네트워크를 사용해서 두 대의 컴퓨터의 블록 디바이스간 데이터를 미러링한다.
  - 네트워크를 이용한 RAID 1이라 생각하면 알기 쉽다.
  - 구조 : 마스터 서버 <-> 백업 서버
  - 구성
    - 커널 모듈(디바이스 드라이버)
    - 유저랜드(userland) 툴
  - DRBD는 파일단위로 데이터를 전송하는게 아니라
    - 블록 디바이스에 대해 변경사항을 실시간으로 전송한다.
  - DRBD는 마스터 서버에 문제가 발생하더라도 자동으로 Failover를 하지 않는다.
    - 장애극복 솔루션과 결합이 필요 -> keepavlied?
  - 미러링하더라도, 백업은 필요하다.
    - 실수로 데이터를 삭제하면 백업에도 바로 반영이 되므로
    - 최악의 경우를 대비해 박업은 해두자.